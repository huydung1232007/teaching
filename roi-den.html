<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>R·ªçi ƒê√®n T√¨m Ki·∫øm VIP</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #f1c40f;
            --gold-glow: rgba(241, 196, 15, 0.6);
            --bg-dark: #0f172a;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0; height: 100vh; overflow: hidden;
            background-color: var(--bg-dark);
            /* H·ªça ti·∫øt n·ªÅn l∆∞·ªõi m·ªù */
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            font-family: 'Inter', sans-serif;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        .back-btn {
            position: absolute; top: 20px; left: 20px; padding: 10px 25px;
            background: var(--glass); border: 1px solid var(--border);
            text-decoration: none; border-radius: 30px; font-weight: 600; color: var(--gold);
            backdrop-filter: blur(10px); z-index: 1000; transition: 0.3s;
        }
        .back-btn:hover { background: rgba(255,255,255,0.1); }

        /* --- S√ÇN KH·∫§U CH·ª®A T√äN --- */
        .stage-container {
            width: 90%;
            height: 70%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center;
            gap: 15px;
            position: relative;
            z-index: 10;
        }

        /* √î T√äN (STYLE M·ªöI) */
        .name-card {
            background: var(--glass);
            border: 1px solid var(--border);
            padding: 15px 25px;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.4); /* M·ªù khi ch∆∞a r·ªçi */
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            min-width: 120px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* Tr·∫°ng th√°i ƒë∆∞·ª£c ƒë√®n r·ªçi tr√∫ng */
        .name-card.lit {
            background: rgba(241, 196, 15, 0.15); /* N·ªÅn v√†ng nh·∫°t */
            border-color: var(--gold);
            color: #fff;
            transform: scale(1.15);
            box-shadow: 0 0 25px var(--gold-glow), inset 0 0 10px var(--gold-glow);
            z-index: 20;
            text-shadow: 0 0 5px var(--gold);
        }

        /* SPOTLIGHT (V√ôNG S√ÅNG DI CHUY·ªÇN) */
        .spotlight-beam {
            position: fixed; top: 50%; left: 50%;
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 60%);
            transform: translate(-50%, -50%);
            pointer-events: none; z-index: 5;
            transition: all 0.1s linear; /* Di chuy·ªÉn m∆∞·ª£t */
            mix-blend-mode: overlay;
            display: none;
        }

        /* CONTROL PANEL */
        .control-panel {
            position: absolute; bottom: 50px; z-index: 100;
        }
        .start-btn {
            background: linear-gradient(135deg, #f1c40f 0%, #d4ac0d 100%);
            color: #0f172a; border: none;
            padding: 18px 60px; font-size: 18px; font-weight: 800; letter-spacing: 1px;
            border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 30px rgba(241, 196, 15, 0.3);
            transition: 0.3s; text-transform: uppercase;
        }
        .start-btn:hover { transform: scale(1.05); box-shadow: 0 0 50px rgba(241, 196, 15, 0.6); }

        /* POPUP */
        .fixed-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 50000; display: none; backdrop-filter: blur(8px); animation: fadeIn 0.3s; }
        .fixed-overlay.active { display: block; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        
        .winner-popup-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); width: 400px; z-index: 50001; transition: 0.4s; pointer-events: none; opacity: 0; }
        .winner-popup-container.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }
        
        .popup-card { 
            width: 100%; padding: 50px 30px; border-radius: 20px; 
            background: linear-gradient(145deg, #1e293b, #0f172a); 
            border: 4px solid var(--gold); 
            box-shadow: 0 0 80px rgba(241, 196, 15, 0.4); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        .popup-icon { font-size: 60px; margin-bottom: 20px; text-shadow: 0 0 20px var(--gold); }
        .popup-label { font-size: 12px; letter-spacing: 4px; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; }
        .popup-name { font-family: 'Playfair Display', serif; font-size: 42px; color: var(--gold); margin-bottom: 30px; text-align: center; line-height: 1.2; text-shadow: 0 2px 10px rgba(0,0,0,0.5);}
        .popup-close-btn { background: transparent; color: var(--gold); border: 1px solid var(--gold); padding: 10px 40px; border-radius: 30px; cursor: pointer; font-weight: bold; transition:0.3s;}
        .popup-close-btn:hover { background: var(--gold); color: #0f172a; }
        
        #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 99999; }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">‚¨Ö Trang Ch·ªß</a>
    <canvas id="confettiCanvas"></canvas>

    <div class="fixed-overlay" id="overlay" onclick="closePopup()"></div>
    <div class="winner-popup-container" id="popup">
        <div class="popup-card">
            <div class="popup-icon">üî¶</div>
            <div class="popup-label">NG∆Ø·ªúI ƒê∆Ø·ª¢C CH·ªåN</div>
            <div class="popup-name" id="popupName">...</div>
            <button class="popup-close-btn" onclick="closePopup()">X√°c Nh·∫≠n</button>
        </div>
    </div>

    <!-- ƒê√®n r·ªçi -->
    <div class="spotlight-beam" id="spotlight"></div>

    <!-- Khu v·ª±c hi·ªÉn th·ªã t√™n (D·∫°ng l∆∞·ªõi) -->
    <div class="stage-container" id="stage"></div>

    <div class="control-panel">
        <button class="start-btn" onclick="startSearch()">B·∫¨T ƒê√àN R·ªåI</button>
    </div>

    <script>
        let fullList=[], remaining=[];
        function initData(){
            const f=localStorage.getItem('classStudents'); fullList=f?f.split('\n').filter(n=>n.trim()!==''):[];
            const r=localStorage.getItem('remainingStudents'); if(r){remaining=JSON.parse(r)}else{remaining=[...fullList];localStorage.setItem('remainingStudents',JSON.stringify(remaining));}
        }
        initData();

        function getUnique(){
            initData(); if(remaining.length===0){if(fullList.length===0) return alert("Ch∆∞a c√≥ danh s√°ch!"); if(confirm("H·∫øt danh s√°ch! Reset?")){remaining=[...fullList];localStorage.setItem('remainingStudents',JSON.stringify(remaining));}else return null;}
            const idx=Math.floor(Math.random()*remaining.length); const w=remaining[idx];
            remaining.splice(idx,1); localStorage.setItem('remainingStudents',JSON.stringify(remaining));
            return w;
        }

        // Render t√™n d·∫°ng Card
        function renderNames() {
            const stage = document.getElementById('stage');
            stage.innerHTML = '';
            // L·∫•y t·ªëi ƒëa 40 ng∆∞·ªùi ƒë·ªÉ hi·ªÉn th·ªã cho ƒë·∫πp
            let displayList = remaining.length > 40 ? remaining.sort(()=>0.5-Math.random()).slice(0,40) : remaining;
            
            // N·∫øu √≠t qu√° th√¨ l·∫•y th√™m t·ª´ fullList ƒë·ªÉ l·∫•p ƒë·∫ßy m√†n h√¨nh cho ƒë·∫πp (nh∆∞ng ch·ªâ l√† visual)
            if(displayList.length < 20 && fullList.length > 20) {
                const extras = fullList.filter(n => !displayList.includes(n)).slice(0, 20 - displayList.length);
                displayList = displayList.concat(extras);
            }

            // Shuffle ƒë·ªÉ v·ªã tr√≠ kh√¥ng c·ªë ƒë·ªãnh
            displayList.sort(() => 0.5 - Math.random());

            displayList.forEach(name => {
                const div = document.createElement('div');
                div.className = 'name-card';
                div.innerText = name;
                stage.appendChild(div);
            });
        }
        renderNames();

        let searchInterval;
        let isSearching = false;

        function startSearch() {
            if(isSearching) return;
            // X√°c ƒë·ªãnh ng∆∞·ªùi th·∫Øng TR∆Ø·ªöC
            const winner = getUnique(); if(!winner) return;
            
            // Ki·ªÉm tra xem t√™n ng∆∞·ªùi th·∫Øng c√≥ tr√™n m√†n h√¨nh kh√¥ng, n·∫øu kh√¥ng th√¨ g√°n v√†o m·ªôt √¥ b·∫•t k·ª≥
            const cards = document.querySelectorAll('.name-card');
            let winnerCard = null;
            
            // T√¨m card ch·ª©a t√™n winner
            for(let card of cards) { if(card.innerText === winner) { winnerCard = card; break; } }

            // N·∫øu kh√¥ng t√¨m th·∫•y (do winner n·∫±m ngo√†i danh s√°ch hi·ªÉn th·ªã), g√°n ƒë·∫°i v√†o m·ªôt √¥ ng·∫´u nhi√™n
            if(!winnerCard && cards.length > 0) {
                const randIndex = Math.floor(Math.random() * cards.length);
                winnerCard = cards[randIndex];
                winnerCard.innerText = winner; // Tr√°o t√™n visual th√†nh t√™n winner th·∫≠t
            }

            isSearching = true;
            document.querySelector('.start-btn').style.display = 'none';
            const spotlight = document.getElementById('spotlight');
            spotlight.style.display = 'block';
            
            let time = 0;
            const duration = 3500; // Th·ªùi gian ch·∫°y

            // √Çm thanh k·ªãch t√≠nh (n·∫øu mu·ªën th√™m sau n√†y)
            
            searchInterval = setInterval(() => {
                // 1. Di chuy·ªÉn ƒë√®n r·ªçi ng·∫´u nhi√™n
                const x = Math.random() * 80 + 10; 
                const y = Math.random() * 80 + 10;
                spotlight.style.left = x + '%';
                spotlight.style.top = y + '%';

                // 2. Hi·ªáu ·ª©ng nh·∫•p nh√°y c√°c √¥ (Qu√©t qua)
                cards.forEach(c => c.classList.remove('lit'));
                
                // Random 1-2 √¥ s√°ng l√™n gi·∫£ v·ªù ƒë√®n qu√©t tr√∫ng
                const randCard = cards[Math.floor(Math.random() * cards.length)];
                randCard.classList.add('lit');

                time += 100;
                if(time >= duration) stopSearch(winner, winnerCard);

            }, 80); // T·ªëc ƒë·ªô qu√©t
        }

        function stopSearch(winnerName, winnerCardElement) {
            clearInterval(searchInterval);
            const spotlight = document.getElementById('spotlight');
            
            // T·∫Øt h·∫øt ƒë√®n c√°c √¥ kh√°c
            document.querySelectorAll('.name-card').forEach(c => c.classList.remove('lit'));

            // T·∫Øt ƒë√®n r·ªçi di chuy·ªÉn
            spotlight.style.display = 'none';

            // B·∫¨T ƒê√àN √î CHI·∫æN TH·∫ÆNG
            if(winnerCardElement) {
                winnerCardElement.classList.add('lit');
                winnerCardElement.style.transform = 'scale(1.3)';
                winnerCardElement.style.zIndex = '100';
            }

            // Hi·ªán popup sau 1s
            setTimeout(() => {
                showPopup(winnerName);
                isSearching = false;
            }, 1200);
        }

        function showPopup(n){
            document.getElementById('popupName').innerText=n;
            document.getElementById('overlay').classList.add('active');
            document.getElementById('popup').classList.add('active');
            fireConfetti();
        }
        function closePopup(){
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('popup').classList.remove('active');
            document.querySelector('.start-btn').style.display = 'block';
            renderNames(); // Reset l·∫°i b·∫£ng t√™n
        }

        // Confetti
        const canvas=document.getElementById('confettiCanvas'), ctx=canvas.getContext('2d'); let p=[];
        function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;} window.addEventListener('resize',resizeCanvas); resizeCanvas();
        function fireConfetti(){ p=[]; for(let i=0;i<150;i++) p.push({x:canvas.width/2,y:canvas.height/2,vx:(Math.random()-0.5)*15,vy:(Math.random()-0.5)*15-5,c:'#f1c40f',s:Math.random()*10+5}); animate(); }
        function animate(){ if(p.length===0)return; ctx.clearRect(0,0,canvas.width,canvas.height); p.forEach((pt,i)=>{pt.x+=pt.vx;pt.y+=pt.vy;pt.vy+=0.2;pt.vx*=0.96;pt.vy*=0.96;ctx.fillStyle=pt.c;ctx.fillRect(pt.x,pt.y,pt.s,pt.s);if(pt.y>canvas.height)p.splice(i,1)}); requestAnimationFrame(animate); }
    </script>
</body>
</html>
