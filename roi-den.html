<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>S√¢n Kh·∫•u Doanh Nh√¢n</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e293b; 
            --accent: #f1c40f; 
            --bg: #f8fafc;
            --curtain-red: #7f1d1d; /* ƒê·ªè nhung */
        }

        body {
            margin: 0; height: 100vh; overflow: hidden;
            background-color: var(--bg);
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
            font-family: 'Inter', sans-serif;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            user-select: none;
        }

        .back-btn {
            position: absolute; top: 20px; left: 20px; padding: 10px 25px;
            background: white; border: 1px solid #e2e8f0;
            text-decoration: none; border-radius: 30px; font-weight: 600; color: var(--primary);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 1000;
        }

        /* --- S√ÇN KH·∫§U & T√äN --- */
        .stage-container {
            width: 90%; height: 75%;
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center;
            gap: 15px; position: relative; z-index: 10;
        }

        .name-card {
            background: white; border: 1px solid #e2e8f0;
            padding: 15px 30px; border-radius: 8px;
            color: #334155; font-size: 16px; font-weight: 600; text-align: center;
            min-width: 140px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s; position: relative;
        }
        .name-card.lit {
            background: #fffbeb; border-color: var(--accent); color: var(--primary);
            transform: scale(1.15); box-shadow: 0 10px 25px rgba(241, 196, 15, 0.4); z-index: 20;
        }

        /* --- ƒê√àN R·ªåI --- */
        .spotlight-beam {
            position: fixed; top: 50%; left: 50%;
            width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(241, 196, 15, 0.6) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            pointer-events: none; z-index: 5;
            display: none; mix-blend-mode: multiply;
        }

        .control-panel { position: absolute; bottom: 40px; z-index: 100; }
        .start-btn {
            background: var(--primary); color: white; border: none;
            padding: 16px 50px; font-size: 16px; font-weight: 700; border-radius: 50px; cursor: pointer;
            box-shadow: 0 10px 20px rgba(30, 41, 59, 0.3); transition: 0.3s;
        }
        .start-btn:hover { transform: translateY(-3px); background: #334155; }

        /* --- R√àM S√ÇN KH·∫§U (REALISTIC CURTAIN) --- */
        .curtain-layer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 60000; pointer-events: none; display: flex;
        }
        
        .curtain-panel {
            width: 50%; height: 100%; position: relative;
            transition: transform 1.5s cubic-bezier(0.77, 0, 0.175, 1); /* Chuy·ªÉn ƒë·ªông m∆∞·ª£t ki·ªÉu v·∫≠t l√Ω */
            
            /* T·∫†O HI·ªÜU ·ª®NG V·∫¢I NHUNG V√Ä N·∫æP G·∫§P B·∫∞NG GRADIENT */
            background-color: var(--curtain-red);
            background-image: repeating-linear-gradient(
                90deg,
                #500f0f,       /* M√†u t·ªëi (khe n·∫øp g·∫•p) */
                #7f1d1d 20px,  /* M√†u ch√≠nh */
                #991b1b 40px,  /* M√†u s√°ng (ƒë·ªânh n·∫øp g·∫•p) */
                #7f1d1d 60px,  /* Quay l·∫°i m√†u ch√≠nh */
                #500f0f 80px   /* Quay l·∫°i m√†u t·ªëi */
            );
            box-shadow: inset 0 0 80px rgba(0,0,0,0.7); /* ƒê·ªï b√≥ng s√¢u v√†o trong */
        }

        .curtain-panel.left { 
            transform: translateX(-100%); /* M·∫∑c ƒë·ªãnh ·∫©n b√™n tr√°i */
            border-right: 4px solid #f59e0b; /* Vi·ªÅn v√†ng tua rua */
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        }
        
        .curtain-panel.right { 
            transform: translateX(100%); /* M·∫∑c ƒë·ªãnh ·∫©n b√™n ph·∫£i */
            border-left: 4px solid #f59e0b; 
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
        }

        /* Khi class .closed ƒë∆∞·ª£c th√™m v√†o -> R√®m ƒë√≥ng l·∫°i */
        .curtain-layer.closed .curtain-panel { transform: translateX(0); }

        /* --- POPUP WINNER --- */
        .winner-popup-container { 
            position: fixed; 
            top: 0; left: 0;
            width: 100vw; height: 100vh; /* Chi·∫øm to√†n m√†n h√¨nh */
            z-index: 60001;
            
            /* D√πng Flexbox ƒë·ªÉ cƒÉn gi·ªØa tuy·ªát ƒë·ªëi n·ªôi dung b√™n trong */
            display: flex;
            justify-content: center; /* CƒÉn gi·ªØa ngang */
            align-items: center;     /* CƒÉn gi·ªØa d·ªçc */
            
            opacity: 0; 
            transition: opacity 0.5s; 
            pointer-events: none;
            /* N·∫øu mu·ªën n·ªÅn m·ªù t·ªëi ph√≠a sau popup, b·ªè comment d√≤ng d∆∞·ªõi */
            /* background: rgba(0,0,0,0.5); */
        }
        
        /* Khi active th√¨ hi·ªán container l√™n */
        .winner-popup-container.active { 
            opacity: 1; 
            pointer-events: auto; 
        }
        
        /* Th·∫ª popup lo ph·∫ßn hi·ªÉn th·ªã v√† hi·ªáu ·ª©ng ph√≥ng to */
        .popup-card { 
            width: 400px; /* Chi·ªÅu r·ªông c·ªë ƒë·ªãnh */
            padding: 40px; 
            border-radius: 12px; 
            background: #fff; 
            border: 4px solid var(--accent); 
            box-shadow: 0 0 60px rgba(241, 196, 15, 0.6); 
            text-align: center; 
            display: flex; flex-direction: column; align-items: center;

            /* Hi·ªáu ·ª©ng ph√≥ng to khi hi·ªán */
            transform: scale(0.8);
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Khi container cha active, th·∫ª con ph√≥ng to v·ªÅ 1 */
        .winner-popup-container.active .popup-card {
            transform: scale(1);
        }
        
        .popup-name { font-family: 'Playfair Display', serif; font-size: 45px; color: var(--curtain-red); margin: 20px 0; font-weight: 800; line-height: 1.1; }
        .popup-close-btn { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 99999; }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">‚¨Ö Trang Ch·ªß</a>
    <canvas id="confettiCanvas"></canvas>

    <div class="curtain-layer" id="curtainLayer">
        <div class="curtain-panel left"></div>
        <div class="curtain-panel right"></div>
    </div>

    <div class="winner-popup-container" id="popup">
        <div class="popup-card">
            <div style="font-size: 50px;">üëë</div>
            <div style="color:#64748b; font-weight:bold; letter-spacing:2px; margin-top:10px;">NG∆Ø·ªúI CHI·∫æN TH·∫ÆNG L√Ä</div>
            <div class="popup-name" id="popupName">Nguyen Van A</div>
            <button class="popup-close-btn" onclick="closePopup()">ƒê√≥ng & Ti·∫øp T·ª•c</button>
        </div>
    </div>

    <div class="spotlight-beam" id="spotlight"></div>
    <div class="stage-container" id="stage"></div>

    <div class="control-panel">
        <button class="start-btn" onclick="startSearch()">B·∫ÆT ƒê·∫¶U QU√âT</button>
    </div>

    <script>
        let fullList=[], remaining=[];
        function initData(){
            const f=localStorage.getItem('classStudents'); fullList=f?f.split('\n').filter(n=>n.trim()!==''):[];
            const r=localStorage.getItem('remainingStudents'); if(r){remaining=JSON.parse(r)}else{remaining=[...fullList];localStorage.setItem('remainingStudents',JSON.stringify(remaining));}
        }
        initData();

        function getUnique(){
            initData(); if(remaining.length===0){if(fullList.length===0) return alert("Ch∆∞a c√≥ danh s√°ch!"); if(confirm("H·∫øt danh s√°ch! Reset?")){remaining=[...fullList];localStorage.setItem('remainingStudents',JSON.stringify(remaining));}else return null;}
            const idx=Math.floor(Math.random()*remaining.length); const w=remaining[idx];
            remaining.splice(idx,1); localStorage.setItem('remainingStudents',JSON.stringify(remaining));
            return w;
        }

        function renderNames() {
            const stage = document.getElementById('stage'); stage.innerHTML = '';
            let displayList = remaining.length > 40 ? remaining.sort(()=>0.5-Math.random()).slice(0,40) : remaining;
            if(displayList.length < 20 && fullList.length > 20) {
                const extras = fullList.filter(n => !displayList.includes(n)).slice(0, 20 - displayList.length);
                displayList = displayList.concat(extras);
            }
            displayList.sort(() => 0.5 - Math.random());
            displayList.forEach(name => {
                const div = document.createElement('div'); div.className = 'name-card'; div.innerText = name; stage.appendChild(div);
            });
        }
        renderNames();

        let searchInterval; let isSearching = false;

        function startSearch() {
            if(isSearching) return;
            const winner = getUnique(); if(!winner) return;
            
            // G√°n winner v√†o 1 th·∫ª b·∫•t k·ª≥
            const cards = document.querySelectorAll('.name-card');
            let winnerCard = null;
            for(let card of cards) { if(card.innerText === winner) { winnerCard = card; break; } }
            if(!winnerCard && cards.length > 0) {
                const randIndex = Math.floor(Math.random() * cards.length);
                winnerCard = cards[randIndex]; winnerCard.innerText = winner; 
            }

            isSearching = true;
            document.querySelector('.start-btn').style.display = 'none';
            document.getElementById('spotlight').style.display = 'block';
            
            let time = 0; const duration = 6000; // Th·ªùi gian r·ªçi ƒë√®n

            searchInterval = setInterval(() => {
                const x = Math.random() * 90 + 5; const y = Math.random() * 80 + 10;
                document.getElementById('spotlight').style.left = x + '%';
                document.getElementById('spotlight').style.top = y + '%';
                cards.forEach(c => c.classList.remove('lit'));
                if(cards.length > 0) cards[Math.floor(Math.random()*cards.length)].classList.add('lit');
                time += 150; if(time >= duration) stopSearch(winner, winnerCard);
            }, 150);
        }

        function stopSearch(winnerName, winnerCardElement) {
            clearInterval(searchInterval);
            document.getElementById('spotlight').style.display = 'none';
            document.querySelectorAll('.name-card').forEach(c => c.classList.remove('lit'));
            if(winnerCardElement) {
                winnerCardElement.classList.add('lit'); 
                winnerCardElement.style.transform = 'scale(1.3)';
                winnerCardElement.style.zIndex = '100';
            }
            setTimeout(() => { triggerCurtainReveal(winnerName); }, 1000);
        }

        // --- H√ÄM ƒê√É S·ª¨A L·∫†I ---
function triggerCurtainReveal(name) {
    const curtain = document.getElementById('curtainLayer');
    
    // 1. ƒê√≥ng r√®m l·∫°i (Che k√≠n m√†n h√¨nh)
    curtain.classList.add('closed');

    // 2. Trong l√∫c r√®m ƒëang ƒë√≥ng, setup s·∫µn t√™n cho popup (nh∆∞ng ch∆∞a hi·ªán popup)
    setTimeout(() => {
        document.getElementById('popupName').innerText = name;
        // L∆ØU √ù: Kh√¥ng th√™m class 'active' cho popup ·ªü ƒë√¢y n·ªØa!
    }, 1500); // ƒê·ª£i 1.5s cho r√®m ƒë√≥ng h·∫≥n

    // 3. M·ªü r√®m ra (V√©n m√†n b√≠ m·∫≠t) v√† SAU ƒê√ì m·ªõi hi·ªán popup
    setTimeout(() => {
        curtain.classList.remove('closed'); // R√®m b·∫Øt ƒë·∫ßu m·ªü
        
        // --- CH·ªàNH S·ª¨A CH√çNH ·ªû ƒê√ÇY ---
        // ƒê·ª£i th√™m 1 ch√∫t (v√≠ d·ª•: 0.5s) ƒë·ªÉ r√®m m·ªü ra r·ªìi m·ªõi hi·ªán popup
        setTimeout(() => {
             document.getElementById('popup').classList.add('active'); // Hi·ªán popup
             fireConfetti(); // B·∫Øn ph√°o gi·∫•y
        }, 500); 

    }, 2500); // T·ªïng th·ªùi gian t·ª´ khi b·∫Øt ƒë·∫ßu ƒë√≥ng r√®m ƒë·∫øn khi b·∫Øt ƒë·∫ßu m·ªü r√®m l√† 2.5s
}

        function closePopup(){
            document.getElementById('popup').classList.remove('active');
            document.querySelector('.start-btn').style.display = 'block';
            isSearching = false; renderNames(); 
        }

        // Ph√°o gi·∫•y
        const canvas=document.getElementById('confettiCanvas'), ctx=canvas.getContext('2d'); let p=[];
        function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;} window.addEventListener('resize',resizeCanvas); resizeCanvas();
        function fireConfetti(){ p=[]; for(let i=0;i<150;i++) p.push({x:canvas.width/2,y:canvas.height/2,vx:(Math.random()-0.5)*20,vy:(Math.random()-0.5)*20-5,c:'#f1c40f',s:Math.random()*10+5}); animate(); }
        function animate(){ if(p.length===0)return; ctx.clearRect(0,0,canvas.width,canvas.height); p.forEach((pt,i)=>{pt.x+=pt.vx;pt.y+=pt.vy;pt.vy+=0.2;pt.vx*=0.96;pt.vy*=0.96;ctx.fillStyle=pt.c;ctx.fillRect(pt.x,pt.y,pt.s,pt.s);if(pt.y>canvas.height)p.splice(i,1)}); requestAnimationFrame(animate); }
    </script>
</body>
</html>
