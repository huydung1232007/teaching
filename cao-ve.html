<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Lucky Ticket</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0; height: 100vh;
            background-color: #f8f9fa; /* M√†u n·ªÅn s√°ng s·∫°ch */
            background-image: radial-gradient(#e9ecef 2px, transparent 2px);
            background-size: 30px 30px;
            font-family: 'Roboto', sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            user-select: none; overflow: hidden;
        }

        .back-btn {
            position: absolute; top: 20px; left: 20px;
            padding: 10px 25px; background: #fff;
            border: 1px solid #dee2e6; border-radius: 6px;
            text-decoration: none; color: #343a40; font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .back-btn:hover { background: #e9ecef; }

        /* V√â S·ªê KI·ªÇU DOANH NH√ÇN */
        .ticket-container {
            width: 700px; height: 350px;
            background: #fff;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-radius: 12px;
            display: flex; overflow: hidden;
            border: 1px solid #ced4da;
        }

        .ticket-left {
            width: 35%; background: #1e293b; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-right: 2px dashed #475569; position: relative;
        }
        .ticket-left::after { /* L·ªó tr√≤n gi·∫£ v√© x√© */
            content: ""; position: absolute; right: -10px; top: -10px; width: 20px; height: 20px;
            background: #f8f9fa; border-radius: 50%;
        }
        .ticket-left::before {
            content: ""; position: absolute; right: -10px; bottom: -10px; width: 20px; height: 20px;
            background: #f8f9fa; border-radius: 50%;
        }

        .company-name { font-size: 14px; text-transform: uppercase; letter-spacing: 2px; color: #94a3b8; }
        .ticket-title { font-family: 'Playfair Display', serif; font-size: 40px; margin: 10px 0; color: #f1c40f; }
        .serial { font-family: monospace; font-size: 14px; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 4px; }

        .ticket-right {
            width: 65%; padding: 30px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #fff;
        }

        .scratch-area {
            position: relative; width: 400px; height: 180px;
            border: 2px solid #e9ecef; background: #f8f9fa;
            border-radius: 8px; overflow: hidden;
        }

        .hidden-result {
            position: absolute; top:0; left:0; width:100%; height:100%;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Playfair Display', serif; font-size: 36px;
            color: #1e293b; z-index: 1;
        }

        canvas { position: absolute; top:0; left:0; z-index: 2; cursor: crosshair; }

        .btn-new {
            margin-top: 30px; padding: 12px 40px;
            background: #1e293b; color: white; border: none;
            border-radius: 6px; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 10px rgba(30, 41, 59, 0.3); transition: 0.2s;
        }
        .btn-new:hover { background: #334155; transform: translateY(-2px); }

        /* History Box */
        .history-box {
            position: absolute; top: 20px; right: 20px;
            width: 250px; background: #fff; border: 1px solid #dee2e6;
            border-radius: 8px; padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); z-index: 50;
        }
        .history-title { font-weight: 700; color: #1e293b; border-bottom: 2px solid #1e293b; padding-bottom: 8px; margin-bottom: 10px; font-size: 14px; text-transform: uppercase;}
        .history-list { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
        .history-item { font-size: 14px; padding: 8px 0; border-bottom: 1px solid #f1f5f9; color: #475569; }

        /* Popup */
        .fixed-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 900; display: none; backdrop-filter: blur(2px);}
        .fixed-overlay.active { display: block; }
        
        .popup-card {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8);
            background: white; padding: 40px; border-radius: 12px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2); z-index: 901;
            opacity: 0; pointer-events: none; transition: 0.3s;
            width: 400px; border: 1px solid #e2e8f0;
        }
        .popup-card.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }
        
        .popup-icon { font-size: 60px; margin-bottom: 20px; color: #f1c40f; }
        .popup-winner { font-family: 'Playfair Display', serif; font-size: 40px; color: #1e293b; margin-bottom: 10px; }
        .close-popup { background: #1e293b; color: white; border: none; padding: 10px 30px; border-radius: 4px; cursor: pointer; margin-top: 20px; }

        #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">‚¨Ö Trang Ch·ªß</a>
    <canvas id="confettiCanvas"></canvas>

    <div class="history-box">
        <div class="history-title">Danh s√°ch tr√∫ng th∆∞·ªüng</div>
        <ul class="history-list" id="historyList"></ul>
    </div>

    <div class="fixed-overlay" id="overlay" onclick="closePopup()"></div>
    <div class="popup-card" id="popup">
        <div class="popup-icon">üèÜ</div>
        <div style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 2px;">Congratulations</div>
        <div class="popup-winner" id="popupName">Name</div>
        <button class="close-popup" onclick="closePopup()">X√°c Nh·∫≠n</button>
    </div>

    <div class="ticket-container">
        <div class="ticket-left">
            <div class="company-name">Lucky Draw </div>
            <div class="ticket-title">S·ªï X·ªë</div>
            <div class="serial">No. 2025 -VIP</div>
        </div>
        <div class="ticket-right">
            <div style="color:#64748b; font-weight:500; margin-bottom:15px; text-transform: uppercase; font-size: 12px; letter-spacing: 1px;">C√†o l·ªõp b·∫°c b√™n d∆∞·ªõi</div>
            <div class="scratch-area">
                <div class="hidden-result" id="resultName">...</div>
                <canvas id="scratchCanvas" width="400" height="180"></canvas>
            </div>
        </div>
    </div>
    <button class="btn-new" onclick="initCard()"> Mua V√© M·ªõi </button>

    <script>
        // --- LOGIC (Gi·ªØ nguy√™n logic c≈©, ch·ªâ thay ƒë·ªïi giao di·ªán v·∫Ω canvas) ---
        let fullList = [], remaining = [];
        function initData() {
            const f = localStorage.getItem('classStudents');
            fullList = f ? f.split('\n').filter(n => n.trim() !== '') : [];
            const r = localStorage.getItem('remainingStudents');
            if (r) { remaining = JSON.parse(r); } 
            else { remaining = [...fullList]; localStorage.setItem('remainingStudents', JSON.stringify(remaining)); }
            renderHistory();
        }
        function renderHistory() {
            const l = document.getElementById('historyList'); l.innerHTML = '';
            if (fullList.length > 0) {
                const remSet = new Set(remaining);
                const winners = fullList.filter(x => !remSet.has(x));
                winners.forEach(n => {
                    const li = document.createElement('li');
                    li.className = 'history-item'; li.innerText = n;
                    l.appendChild(li);
                });
                l.scrollTop = l.scrollHeight;
            }
        }
        function getUnique() {
            initData();
            if (remaining.length === 0) {
                if (fullList.length === 0) { alert("Ch∆∞a nh·∫≠p t√™n!"); return null; }
                if (confirm("H·∫øt danh s√°ch! Reset l·∫°i?")) {
                    remaining = [...fullList]; localStorage.setItem('remainingStudents', JSON.stringify(remaining)); renderHistory();
                } else return null;
            }
            const i = Math.floor(Math.random() * remaining.length);
            const w = remaining[i];
            remaining.splice(i, 1);
            localStorage.setItem('remainingStudents', JSON.stringify(remaining));
            return w;
        }

        // --- DRAWING LOGIC (SILVER FOIL) ---
        const canvas = document.getElementById('scratchCanvas');
        const ctx = canvas.getContext('2d');
        const w = 400, h = 180;
        let isDrawing = false, isRevealed = false, currentWinner = "", checkCounter=0;

        function initCard() {
            closePopup(); isRevealed = false;
            currentWinner = getUnique(); if (!currentWinner) return;
            document.getElementById('resultName').innerText = currentWinner;

            ctx.globalCompositeOperation = 'source-over';
            // M√†u b·∫°c kim lo·∫°i (Metal Gradient)
            const grd = ctx.createLinearGradient(0, 0, w, h);
            grd.addColorStop(0, '#e0e0e0');
            grd.addColorStop(0.5, '#ffffff');
            grd.addColorStop(1, '#bdbdbd');
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, w, h);

            // Pattern logo ch√¨m
            ctx.fillStyle = "rgba(0,0,0,0.05)";
            ctx.font = "bold 20px Arial";
            for(let i=0; i<6; i++) for(let j=0; j<4; j++) ctx.fillText("VIP", i*80 + 20, j*50 + 30);

            // Ch·ªØ h∆∞·ªõng d·∫´n
            ctx.fillStyle = "#757575";
            ctx.font = "bold 20px Roboto";
            const txt = "C√ÄO NGAY";
            const tw = ctx.measureText(txt).width;
            ctx.fillText(txt, (w-tw)/2, h/2+8);

            ctx.globalCompositeOperation = 'destination-out';
            ctx.lineJoin = 'round'; ctx.lineCap = 'round'; ctx.lineWidth = 40;
        }

        function getPos(e) {
            const r = canvas.getBoundingClientRect();
            return { x: (e.touches ? e.touches[0].clientX : e.clientX) - r.left, y: (e.touches ? e.touches[0].clientY : e.clientY) - r.top };
        }
        let lastPoint = null;
        function startScratch(e) { isDrawing = true; lastPoint = getPos(e); }
        function moveScratch(e) {
            if (!isDrawing || isRevealed) return;
            e.preventDefault();
            const cur = getPos(e);
            ctx.beginPath(); ctx.moveTo(lastPoint.x, lastPoint.y); ctx.lineTo(cur.x, cur.y); ctx.stroke();
            lastPoint = cur;
            checkCounter++; if (checkCounter % 5 === 0) check();
        }
        function endScratch() { isDrawing = false; if(!isRevealed) check(); }
        function check() {
            if(isRevealed) return;
            const d = ctx.getImageData(0, 0, w, h).data;
            let t = 0; const step = 50;
            for (let i = 3; i < d.length; i += step * 4) if (d[i] === 0) t++;
            if ((t / (d.length / (step * 4))) * 100 > 40) reveal();
        }
        function reveal() {
            if(isRevealed) return;
            isRevealed = true; ctx.clearRect(0, 0, w, h);
            renderHistory(); showPopup(currentWinner);
        }
        function showPopup(n) {
            document.getElementById('popupName').innerText = n;
            document.getElementById('overlay').classList.add('active');
            document.getElementById('popup').classList.add('active');
            fireConfetti();
        }
        function closePopup() {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('popup').classList.remove('active');
        }

        canvas.addEventListener('mousedown', startScratch); canvas.addEventListener('mousemove', moveScratch); canvas.addEventListener('mouseup', endScratch); canvas.addEventListener('mouseleave', endScratch);
        canvas.addEventListener('touchstart', startScratch); canvas.addEventListener('touchmove', moveScratch); canvas.addEventListener('touchend', endScratch);

        initData(); initCard();

        // Confetti (Gold only)
        const c = document.getElementById('confettiCanvas'), cx = c.getContext('2d');
        let p = [];
        function resizeCanvas() { c.width = window.innerWidth; c.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();
        function fireConfetti() {
            p = []; for (let i = 0; i < 150; i++) p.push({ x: c.width/2, y: c.height/2, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15-5, c:'#f1c40f', s:Math.random()*8+4 });
            loop();
        }
        function loop() {
            if (p.length === 0) return;
            cx.clearRect(0, 0, c.width, c.height);
            p.forEach((pt, i) => { pt.x+=pt.vx; pt.y+=pt.vy; pt.vy+=0.2; pt.vx*=0.96; pt.vy*=0.96; cx.fillStyle=pt.c; cx.fillRect(pt.x,pt.y,pt.s,pt.s); if(pt.y>c.height) p.splice(i,1); });
            requestAnimationFrame(loop);
        }
    </script>
</body>

</html>
